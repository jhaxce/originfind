name: Build and Release Binaries

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Multi-Platform Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries for all platforms
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p build dist
          
          echo "Building origindive ${VERSION} for multiple platforms..."
          
          # Function to create release package
          create_package() {
            local os=$1
            local arch=$2
            local binary_name=$3
            # Use underscore-separated name to match updater expectations: origindive_<version>_<os>_<arch>
            local pkg_name="origindive_${VERSION}_${os}_${arch}"
            
            echo "Creating package: ${pkg_name}"
            mkdir -p "build/${pkg_name}"
            
            # Build binary
            GOOS=${os} GOARCH=${arch} go build -ldflags="-s -w" -o "build/${pkg_name}/${binary_name}" cmd/origindive/main.go
            
            # Copy documentation
            cp LICENSE "build/${pkg_name}/"
            cp README.md "build/${pkg_name}/"
            cp CHANGELOG.md "build/${pkg_name}/"
            
            # Create archive: .zip for Windows, .tar.gz for Unix-like
            cd build
            if [ "${os}" = "windows" ]; then
              zip -r "../dist/${pkg_name}.zip" "${pkg_name}"
            else
              tar -czf "../dist/${pkg_name}.tar.gz" "${pkg_name}"
            fi
            cd ..
            
            if [ "${os}" = "windows" ]; then
              echo "✓ Created ${pkg_name}.zip"
            else
              echo "✓ Created ${pkg_name}.tar.gz"
            fi
          }
          
          # Build packages
          create_package "windows" "amd64" "origindive.exe"
          create_package "windows" "arm64" "origindive.exe"
          create_package "linux" "amd64" "origindive"
          create_package "linux" "arm64" "origindive"
          create_package "darwin" "amd64" "origindive"
          create_package "darwin" "arm64" "origindive"
          
          echo "Build complete!"
          ls -lh dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation
            
            Download the zip package for your platform and extract it:
            
            ### Windows
            - **Windows 64-bit (Intel/AMD)**: `origindive_${{ steps.version.outputs.VERSION }}_windows_amd64.zip`
            - **Windows ARM64**: `origindive_${{ steps.version.outputs.VERSION }}_windows_arm64.zip`
            
            ### Linux
            - **Linux 64-bit**: `origindive_${{ steps.version.outputs.VERSION }}_linux_amd64.tar.gz`
            - **Linux ARM64**: `origindive_${{ steps.version.outputs.VERSION }}_linux_arm64.tar.gz`
            
            ### macOS
            - **macOS Intel**: `origindive_${{ steps.version.outputs.VERSION }}_darwin_amd64.tar.gz`
            - **macOS Apple Silicon (M1/M2/M3)**: `origindive_${{ steps.version.outputs.VERSION }}_darwin_arm64.tar.gz`
            
            Each package includes:
            - `origindive` or `origindive.exe` (binary)
            - `LICENSE` (MIT License)
            - `README.md` (Documentation)
            - `CHANGELOG.md` (Release Notes)
            
            ## Quick Start
            
            ```bash
            # Extract the zip
            unzip origindive_${{ steps.version.outputs.VERSION }}_*.zip
            cd origindive_${{ steps.version.outputs.VERSION }}_*
            
            # Linux/macOS: Make executable
            chmod +x origindive
            
            # Run
            ./origindive -d example.com -n 192.168.1.0/24
            ```
            
            ## Verify Download
            
            ```bash
            sha256sum origindive_${{ steps.version.outputs.VERSION }}_*.zip
            # Compare with checksums.txt
            ```
            
            ## Update from CLI
            
            If you already have origindive installed:
            ```bash
            ./origindive --update
            ```
            
            See [CHANGELOG.md](https://github.com/jhaxce/origindive/blob/main/CHANGELOG.md) for full release notes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
