name: Build and Release Binaries

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Multi-Platform Binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binaries for all platforms
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          mkdir -p build dist
          
          echo "Building origindive ${VERSION} for multiple platforms..."
          
          # Function to create release package
          create_package() {
            local os=$1
            local arch=$2
            local binary_name=$3
            local pkg_name="origindive-${VERSION}-${os}-${arch}"
            
            echo "Creating package: ${pkg_name}"
            mkdir -p "build/${pkg_name}"
            
            # Build binary
            GOOS=${os} GOARCH=${arch} go build -ldflags="-s -w" -o "build/${pkg_name}/${binary_name}" cmd/origindive/main.go
            
            # Copy documentation
            cp LICENSE "build/${pkg_name}/"
            cp README.md "build/${pkg_name}/"
            cp CHANGELOG.md "build/${pkg_name}/"
            
            # Create zip
            cd build
            zip -r "../dist/${pkg_name}.zip" "${pkg_name}"
            cd ..
            
            echo "âœ“ Created ${pkg_name}.zip"
          }
          
          # Build packages
          create_package "windows" "amd64" "origindive.exe"
          create_package "windows" "arm64" "origindive.exe"
          create_package "linux" "amd64" "origindive"
          create_package "linux" "arm64" "origindive"
          create_package "darwin" "amd64" "origindive"
          create_package "darwin" "arm64" "origindive"
          
          echo "Build complete!"
          ls -lh dist/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Installation
            
            Download the zip package for your platform and extract it:
            
            ### Windows
            - **Windows 64-bit (Intel/AMD)**: `origindive-${{ steps.version.outputs.VERSION }}-windows-amd64.zip`
            - **Windows ARM64**: `origindive-${{ steps.version.outputs.VERSION }}-windows-arm64.zip`
            
            ### Linux
            - **Linux 64-bit**: `origindive-${{ steps.version.outputs.VERSION }}-linux-amd64.zip`
            - **Linux ARM64**: `origindive-${{ steps.version.outputs.VERSION }}-linux-arm64.zip`
            
            ### macOS
            - **macOS Intel**: `origindive-${{ steps.version.outputs.VERSION }}-darwin-amd64.zip`
            - **macOS Apple Silicon (M1/M2/M3)**: `origindive-${{ steps.version.outputs.VERSION }}-darwin-arm64.zip`
            
            Each package includes:
            - `origindive` or `origindive.exe` (binary)
            - `LICENSE` (MIT License)
            - `README.md` (Documentation)
            - `CHANGELOG.md` (Release Notes)
            
            ## Quick Start
            
            ```bash
            # Extract the zip
            unzip origindive-${{ steps.version.outputs.VERSION }}-*.zip
            cd origindive-${{ steps.version.outputs.VERSION }}-*
            
            # Linux/macOS: Make executable
            chmod +x origindive
            
            # Run
            ./origindive -d example.com -n 192.168.1.0/24
            ```
            
            ## Verify Download
            
            ```bash
            sha256sum origindive-*.zip
            # Compare with checksums.txt
            ```
            
            ## Update from CLI
            
            If you already have origindive installed:
            ```bash
            ./origindive --update
            ```
            
            See [CHANGELOG.md](https://github.com/jhaxce/origindive/blob/main/CHANGELOG.md) for full release notes.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
